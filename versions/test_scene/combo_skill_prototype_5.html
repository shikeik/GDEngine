<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>v17.2 Prototype: Strict Input & Move List</title>
    <style>
        /* --- åŸºç¡€ç¯å¢ƒ --- */
        body { margin: 0; background: #222; overflow: hidden; font-family: 'Courier New', monospace; user-select: none; touch-action: none; color: #fff; }
        #game-container { position: relative; width: 100vw; height: 100vh; overflow: hidden; }
        canvas { display: block; width: 100%; height: 100%; }

        /* --- UI: ç´§å‡‘å‹æŒ‡ä»¤å†å² (å·¦ä¾§) --- */
        #ui-history {
            position: absolute; 
            top: 50px; left: 10px; width: 160px; /* çª„ */
            bottom: 250px; /* é¿å¼€æ‘‡æ† */
            pointer-events: none; 
            display: flex; flex-direction: column-reverse; /* æœ€æ–°åœ¨ä¸‹(appendæ¨¡å¼) æˆ– ä¸Š(prependæ¨¡å¼) */
            gap: 2px;
            overflow: hidden;
            /* å®é™…ä¸Šä¸ºäº†é˜²æ­¢é®æŒ¡æ‘‡æ†ï¼Œæˆ‘ä»¬é™åˆ¶æœ€å¤§é«˜åº¦ */
            max-height: 200px;
        }
        .hist-item {
            background: rgba(0,0,0,0.8); border-left: 3px solid #555;
            padding: 3px 6px; 
            font-size: 10px; color: #ccc;
            display: flex; align-items: center; justify-content: space-between;
            animation: slideIn 0.1s forwards;
            flex-shrink: 0; height: 20px;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        
        .hist-item.type-move { border-color: #00eaff; background: linear-gradient(90deg, rgba(0,234,255,0.2), transparent); color: #fff; font-weight: bold; }
        .hist-left { display: flex; align-items: center; }
        .icon { width: 14px; text-align: center; margin-right: 4px; font-weight: bold; }
        .src { font-size: 9px; color: #777; }

        /* --- UI: å‡ºæ‹›è¡¨æŒ‰é’® & å¼¹çª— --- */
        #btn-help {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.5); border: 1px solid #fff; color: #fff;
            width: 30px; height: 30px; border-radius: 50%; 
            font-weight: bold; cursor: pointer; z-index: 100;
            display: flex; align-items: center; justify-content: center;
        }
        #help-modal {
            position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 200;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .help-content {
            background: #222; border: 2px solid #00eaff; padding: 20px;
            max-width: 90%; color: #eee; font-size: 12px;
        }
        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        th, td { border: 1px solid #444; padding: 8px; text-align: left; }
        th { color: #00eaff; }
        .close-hint { margin-top: 20px; color: #888; cursor: pointer; text-decoration: underline; }

        /* --- UI: å…¨å±€æ—¥å¿— --- */
        #ui-log {
            position: absolute; bottom: 20%; left: 50%; transform: translateX(-50%);
            text-align: center; pointer-events: none; text-shadow: 0 0 5px #000;
        }
        .log-msg { font-size: 20px; color: #ffeb3b; font-weight: 900; margin-top: 5px; opacity: 0; transition: opacity 0.5s; }

        /* --- æ§ä»¶ --- */
        #controls-layer { position: absolute; inset: 0; pointer-events: none; }
        .joystick-base {
            position: absolute; bottom: 40px; left: 40px; width: 140px; height: 140px;
            border-radius: 50%; border: 2px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.3); pointer-events: auto;
        }
        .joy-thumb {
            position: absolute; top: 50%; left: 50%; width: 50px; height: 50px;
            margin: -25px; background: rgba(0, 234, 255, 0.5); border-radius: 50%;
            transform: translate(0,0); transition: transform 0.05s;
        }
        .joy-slot {
            position: absolute; width: 6px; height: 6px; background: #666; border-radius: 50%;
            top: 50%; left: 50%; margin: -3px; transform-origin: 0 0;
        }
        /* æ‰‡åŒºé«˜äº®åé¦ˆ */
        .joy-slot.active { background: #00eaff; box-shadow: 0 0 5px #00eaff; transform: scale(1.5); }
        
        .gesture-zone {
            position: absolute; bottom: 0; right: 0; width: 50%; height: 80%;
            border-left: 1px dashed rgba(255,255,255,0.1); pointer-events: auto;
        }
        .gesture-hint { position: absolute; bottom: 10px; right: 10px; color: #555; font-size: 10px; }

        /* å¯åŠ¨é®ç½© */
        #start-overlay {
            position: absolute; inset: 0; background: #111; z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #btn-start {
            padding: 15px 40px; font-size: 20px; font-family: 'Courier New'; font-weight: bold;
            background: transparent; color: #00eaff; border: 2px solid #00eaff;
            cursor: pointer; box-shadow: 0 0 15px rgba(0,234,255,0.2);
        }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="canvas"></canvas>
    
    <!-- UI -->
    <div id="btn-help">?</div>
    <div id="ui-history"></div>
    <div id="ui-log"></div>
    
    <!-- Modal -->
    <div id="help-modal">
        <div class="help-content">
            <h2 style="margin:0 0 10px 0; color:#fff">COMMAND LIST</h2>
            <table>
                <tr><th>MOVE</th><th>KEYBOARD</th><th>TOUCH</th></tr>
                <tr><td>Move</td><td>W A S D</td><td>Joystick</td></tr>
                <tr><td>Jump</td><td>K</td><td>Swipe Up</td></tr>
                <tr><td>Attack</td><td>J</td><td>Tap</td></tr>
                <tr><td>Dash</td><td>L (Hold A/D for dir)</td><td>Swipe L/R</td></tr>
                <tr><td>Ult</td><td>O</td><td>Swipe Down</td></tr>
                <tr><td style="color:#ffeb3b">Flash Slash</td><td>Hold S + Press L</td><td>Hold Stick Down + Swipe</td></tr>
            </table>
            <div class="close-hint" id="btn-close-help">TAP TO CLOSE</div>
        </div>
    </div>

    <!-- Controls -->
    <div id="controls-layer">
        <div class="joystick-base" id="stick-base">
            <div class="joy-thumb" id="stick-thumb"></div>
            <!-- Slots by JS -->
        </div>
        <div class="gesture-zone" id="gesture-pad">
            <div class="gesture-hint">SWIPE AREA</div>
        </div>
    </div>
</div>

<div id="start-overlay">
    <h1>v17.2 SANDBOX</h1>
    <button id="btn-start">START TEST</button>
</div>

<script>
/** 1. CONFIG: COMMAND MANIFEST **/
const COMMAND_MANIFEST = [
    // åŸºç¡€çŠ¶æ€
    { id: 'CMD_MOVE_LEFT',  type: 'STATE', icon: 'â¬…',  triggers: [{hw:'KEY', code:'KeyA'}, {hw:'STICK', dir:'LEFT'}] },
    { id: 'CMD_MOVE_RIGHT', type: 'STATE', icon: 'â¡',  triggers: [{hw:'KEY', code:'KeyD'}, {hw:'STICK', dir:'RIGHT'}] },
    { id: 'CMD_CROUCH',     type: 'STATE', icon: 'â¬‡',  triggers: [{hw:'KEY', code:'KeyS'}, {hw:'STICK', dir:'DOWN'}] },
    
    // è§¦å‘åŠ¨ä½œ
    { id: 'CMD_JUMP',       type: 'TRIG',  icon: 'â¬†',  triggers: [{hw:'KEY', code:'KeyK'}, {hw:'GESTURE', id:'SWIPE_UP'}] },
    { id: 'CMD_ATK',        type: 'TRIG',  icon: 'âš”ï¸', triggers: [{hw:'KEY', code:'KeyJ'}, {hw:'GESTURE', id:'TAP'}] },
    { id: 'CMD_ULT',        type: 'TRIG',  icon: 'â­•',  triggers: [{hw:'KEY', code:'KeyO'}, {hw:'GESTURE', id:'SWIPE_DOWN'}] },
    
    // æŠ€èƒ½ (ç»„åˆé”®)
    { id: 'CMD_DASH_L', type: 'TRIG', icon: 'âª', triggers: [{ hw: 'GESTURE', id: 'SWIPE_LEFT' }, { hw: 'KEY', code: 'KeyL', mod: 'KeyA' }] },
    { id: 'CMD_DASH_R', type: 'TRIG', icon: 'â©', triggers: [{ hw: 'GESTURE', id: 'SWIPE_RIGHT' }, { hw: 'KEY', code: 'KeyL', mod: 'KeyD' }] },
    { id: 'CMD_DASH_AUTO', type: 'TRIG', icon: 'ğŸš€', triggers: [{ hw: 'KEY', code: 'KeyL', mod: null }] }
];

/** 2. INPUT SYSTEM (å½’ä¸€åŒ–) **/
const InputSystem = {
    heldKeys: new Set(),
    virtualState: { moveX: 0, crouch: false },
    
    init() {
        window.addEventListener('keydown', e => {
            if(e.repeat) return;
            this.heldKeys.add(e.code);
            this.processInput('KEY', e.code);
            this.updateVirtualState();
        });
        window.addEventListener('keyup', e => {
            this.heldKeys.delete(e.code);
            this.updateVirtualState();
        });
    },

    processInput(hwType, hwId) {
        for(let cmd of COMMAND_MANIFEST) {
            for(let trig of cmd.triggers) {
                if(trig.hw === hwType && (trig.code === hwId || trig.id === hwId || trig.dir === hwId)) {
                    let modMatch = true;
                    if(trig.hw === 'KEY') {
                        if(trig.mod && !this.heldKeys.has(trig.mod)) modMatch = false;
                        else if(trig.mod === null && (this.heldKeys.has('KeyA') || this.heldKeys.has('KeyD'))) modMatch = false;
                    }
                    if(modMatch) {
                        this.emitCommand(cmd, hwType, hwId);
                        return;
                    }
                }
            }
        }
    },

    emitCommand(cmd, sourceHw, sourceId) {
        // [v17.2 é˜²æŠ–] å¯¹äº STATE ç±»æŒ‡ä»¤ï¼Œè¿™é‡Œå…¶å®æ˜¯æŒ‰é”®æŒ‰ä¸‹æˆ–æ‘‡æ†åŒºåŸŸè¿›å…¥æ—¶è§¦å‘ä¸€æ¬¡
        // å› ä¸º processInput åªåœ¨äº‹ä»¶å‘ç”Ÿ(keydown/zoneChange)æ—¶è°ƒç”¨ï¼Œæœ¬èº«å°±æ˜¯é˜²æŠ–çš„
        ComboEngine.push(cmd.id, `${sourceHw}:${sourceId.replace('Key','')}`);
    },

    updateVirtualState() {
        let vx = 0;
        let down = false;
        
        // Key State
        if(this.heldKeys.has('KeyA')) vx -= 1;
        if(this.heldKeys.has('KeyD')) vx += 1;
        if(this.heldKeys.has('KeyS')) down = true;

        // Stick State (Direct Vector Mapping)
        // ç§»åŠ¨é€»è¾‘ä¾ç„¶æ²¿ç”¨å‘é‡ï¼Œä¿ç•™æ–œå‘ç§»åŠ¨èƒ½åŠ›
        if(TouchInput.stick.x < -0.3) vx = -1;
        if(TouchInput.stick.x > 0.3) vx = 1;
        // æ‘‡æ†çš„ Crouch çŠ¶æ€ç°åœ¨ç”± 8å‘é€»è¾‘ å†³å®šï¼Œè¿˜æ˜¯çº¯åæ ‡ï¼Ÿ
        // ç”¨æˆ·è¦æ±‚: æ–œæ‹‰ä¸èƒ½è§¦å‘é—ªåˆ€.
        // å¦‚æœè¿™é‡Œç”¨ y < -0.5ï¼Œæ–œæ‹‰æ—¶ y ç¡®å® < -0.5ï¼Œä¼šå¯¼è‡´ crouch=trueã€‚
        // æ‰€ä»¥è¿™é‡Œå¿…é¡»å’Œ 8å‘é€»è¾‘ ä¿æŒä¸€è‡´ï¼åªæœ‰åœ¨ DOWN æ‰‡åŒºæ‰ç½®ä¸º crouchã€‚
        if(TouchInput.currentZone === 6) down = true; // 6 is DOWN sector index

        this.virtualState.moveX = vx;
        this.virtualState.crouch = down;
        
        // çŠ¶æ€è¾¹ç¼˜æ£€æµ‹ (Key S press handled by processInput, but Stick Down needs edge detect?)
        // processInput calls handle Stick Zone changes. So we are good.
    }
};

/** 3. TOUCH INPUT (8-Way Strict) **/
const TouchInput = {
    stick: { x: 0, y: 0 },
    currentZone: -1, // 0-7: Directions, -1: Center
    
    init() {
        // Init Visuals
        const base = document.getElementById('stick-base');
        const thumb = document.getElementById('stick-thumb');
        const slots = [];
        for(let i=0; i<8; i++) {
            let d = document.createElement('div');
            d.className = 'joy-slot';
            // ä¿®æ­£è§’åº¦ï¼š0åº¦ä¸ºå³ (CSS rotate 0 is Right if we align correctly)
            // æ•°å­¦ä¸Š: 0=Right, 90=Up, 180=Left, 270=Down
            // CSS: rotate é¡ºæ—¶é’ˆ. 0=Right(if set), 90=Down.
            // Let's use negative rotate to match math CCW.
            d.style.transform = `rotate(${-i*45}deg) translate(65px)`;
            base.appendChild(d);
            slots.push(d);
        }

        const handleStick = (t) => {
            const rect = base.getBoundingClientRect();
            let dx = t.clientX - (rect.left + rect.width/2);
            let dy = t.clientY - (rect.top + rect.height/2);
            let dist = Math.sqrt(dx*dx+dy*dy);
            let max = 40;
            if(dist>max) { dx *= max/dist; dy *= max/dist; }
            
            thumb.style.transform = `translate(${dx}px, ${dy}px)`;
            this.stick.x = dx/max; 
            this.stick.y = -dy/max; // Logic Y Up

            // [v17.2 Core] 8-Way Zone Calculation
            let newZone = -1;
            if(dist > 10) { // Deadzone
                // Angle in Degrees (0-360 CCW, 0=Right)
                let deg = Math.atan2(-dy, dx) * (180/Math.PI);
                if(deg < 0) deg += 360;
                
                // Shift by 22.5 to center sectors
                // Sector 0 (Right): 337.5 ~ 22.5
                // Sector 1 (Up-Right): 22.5 ~ 67.5 ...
                // Math index = floor((deg + 22.5) / 45) % 8
                newZone = Math.floor((deg + 22.5) / 45) % 8;
            }

            // Zone Change Event
            if(newZone !== this.currentZone) {
                // Clear old highlights
                slots.forEach(s => s.classList.remove('active'));
                
                // Trigger Command only on Entry
                if(newZone !== -1) {
                    slots[newZone].classList.add('active');
                    this.mapZoneToCommand(newZone);
                }
                this.currentZone = newZone;
            }
            
            InputSystem.updateVirtualState();
        };

        const resetStick = (e) => {
            e.preventDefault();
            thumb.style.transform = `translate(0,0)`;
            this.stick.x = 0; this.stick.y = 0;
            this.currentZone = -1;
            slots.forEach(s => s.classList.remove('active'));
            InputSystem.updateVirtualState();
        };

        base.addEventListener('touchmove', e => { e.preventDefault(); handleStick(e.changedTouches[0]); });
        base.addEventListener('touchstart', e => { e.preventDefault(); handleStick(e.changedTouches[0]); });
        base.addEventListener('touchend', resetStick);

        // Gestures
        const pad = document.getElementById('gesture-pad');
        let gStart = {x:0, y:0, t:0};
        pad.addEventListener('touchstart', e => { gStart = {x:e.changedTouches[0].clientX, y:e.changedTouches[0].clientY, t:Date.now()}; });
        pad.addEventListener('touchend', e => {
            let dx = e.changedTouches[0].clientX - gStart.x;
            let dy = e.changedTouches[0].clientY - gStart.y;
            if(Date.now()-gStart.t > 400) return;
            if(Math.abs(dx)<20 && Math.abs(dy)<20) InputSystem.processInput('GESTURE', 'TAP');
            else if(Math.abs(dy)>Math.abs(dx)) InputSystem.processInput('GESTURE', dy<-50?'SWIPE_UP':'SWIPE_DOWN');
            else InputSystem.processInput('GESTURE', dx<-50?'SWIPE_LEFT':'SWIPE_RIGHT');
        });
    },

    mapZoneToCommand(zoneIdx) {
        // 0:Right, 1:Up-Right, 2:Up, 3:Up-Left, 4:Left, 5:Down-Left, 6:Down, 7:Down-Right
        // Strict Mapping: Diagonals trigger NOTHING for Combo Buffer (as requested)
        // Cardinals trigger commands
        switch(zoneIdx) {
            case 0: InputSystem.processInput('STICK', 'RIGHT'); break;
            case 4: InputSystem.processInput('STICK', 'LEFT'); break;
            case 6: InputSystem.processInput('STICK', 'DOWN'); break; // Strict Down
            // Case 2 (Up) - reserved for Jump if needed, currently unused in manifest for Stick
        }
    }
};

/** 4. COMBO ENGINE **/
const ComboEngine = {
    buffer: [], timeout: 400, timer: null,
    push(cmdId, source) {
        this.buffer.push({id:cmdId, source:source});
        UI.addHistory(cmdId, source, 'raw');
        if(this.timer) clearTimeout(this.timer);
        this.timer = setTimeout(()=>this.buffer=[], this.timeout);
        this.checkMoves();
    },
    checkMoves() {
        let len = this.buffer.length; if(len===0) return;
        let last = this.buffer[len-1];
        let prev = len>=2 ? this.buffer[len-2] : null;

        // Flash Slash: Strict Crouch -> Dash
        if(prev && prev.id === 'CMD_CROUCH' && last.id.startsWith('CMD_DASH')) {
            this.execute('FLASH SLASH', 'âš¡', last.source); return;
        }
        // Normal Dash (Single press)
        if(last.id.startsWith('CMD_DASH')) {
            let dir = last.id.endsWith('L') ? -1 : (last.id.endsWith('R') ? 1 : 0);
            this.execute('DASH', '>>', last.source, {dir}); return;
        }
        // Instant Triggers
        if(last.id === 'CMD_ATK') { this.execute('ATTACK', 'âš”ï¸', last.source); return; }
        if(last.id === 'CMD_JUMP') { this.execute('JUMP', 'â¬†', last.source); return; }
        if(last.id === 'CMD_ULT') { this.execute('ULTIMATE', 'â­•', last.source); return; }
    },
    execute(name, icon, src, params) {
        UI.addHistory(name, src, 'move', icon);
        UI.showToast(name);
        Game.triggerAction(name, params);
        this.buffer = [];
    }
};

/** 5. GAME & UI **/
const Game = {
    logicW: 1000, logicH: 600, scale: 1, offX: 0, offY: 0,
    player: {x:200, y:400, w:40, h:60, color:'#00eaff', vx:0, vy:0},
    enemy: {x:700, y:400, w:40, h:60, color:'#ff0055'},
    init() {
        this.cvs = document.getElementById('canvas');
        this.ctx = this.cvs.getContext('2d');
        window.addEventListener('resize', ()=>this.fit());
        this.fit(); this.loop();
    },
    fit() {
        let winW=window.innerWidth, winH=window.innerHeight;
        this.cvs.width=winW; this.cvs.height=winH;
        this.scale = Math.min(winW/this.logicW, winH/this.logicH);
        this.offX = (winW - this.logicW*this.scale)/2;
        this.offY = (winH - this.logicH*this.scale)/2;
        this.ctx.setTransform(1,0,0,1,0,0);
    },
    triggerAction(name, p) {
        const pl = this.player;
        if(name==='JUMP') pl.vy = -18;
        if(name==='DASH') {
            let d = p.dir === 0 ? (this.enemy.x>pl.x?1:-1) : p.dir;
            pl.vx = 25*d;
        }
        if(name==='FLASH SLASH') {
            pl.x = this.enemy.x - (100 * (this.enemy.x>pl.x?1:-1));
            pl.vx = 0;
            pl.color = '#fff'; setTimeout(()=>pl.color='#00eaff', 100);
        }
        if(name==='ULTIMATE') { // Big Visual Feedback
            this.bgFlash = 10;
        }
    },
    loop() {
        let ctx = this.ctx, p = this.player;
        // Logic
        if(InputSystem.virtualState.moveX) p.vx = InputSystem.virtualState.moveX*6;
        else p.vx *= 0.8;
        p.vy += 0.8; p.x += p.vx; p.y += p.vy;
        if(p.y > 500-p.h) { p.y = 500-p.h; p.vy=0; }
        // Render
        ctx.fillStyle = this.bgFlash > 0 ? '#333' : '#111'; 
        if(this.bgFlash>0) this.bgFlash--;
        ctx.fillRect(0,0, ctx.canvas.width, ctx.canvas.height);
        
        ctx.save();
        ctx.translate(this.offX, this.offY); ctx.scale(this.scale, this.scale);
        
        ctx.fillStyle='#1a1a1a'; ctx.fillRect(0,0,this.logicW,this.logicH); // Logic Area
        ctx.strokeStyle='#555'; ctx.beginPath(); ctx.moveTo(0,500); ctx.lineTo(1000,500); ctx.stroke();
        
        ctx.fillStyle=this.enemy.color; ctx.fillRect(this.enemy.x,this.enemy.y,this.enemy.w,this.enemy.h);
        
        let ph = InputSystem.virtualState.crouch ? p.h/2 : p.h;
        let py = InputSystem.virtualState.crouch ? p.y+p.h/2 : p.y;
        ctx.fillStyle=p.color; ctx.fillRect(p.x, py, p.w, ph);
        if(InputSystem.virtualState.crouch) { ctx.strokeStyle='#fff'; ctx.lineWidth=2; ctx.strokeRect(p.x-5,py-5,p.w+10,ph+10); }

        ctx.restore();
        requestAnimationFrame(()=>this.loop());
    }
};

const UI = {
    box: document.getElementById('ui-history'),
    toast: document.getElementById('ui-log'),
    addHistory(cmd, src, type, iconOvr) {
        let div = document.createElement('div');
        div.className = `hist-item type-${type}`;
        let meta = COMMAND_MANIFEST.find(c=>c.id===cmd)||{icon:'?',id:cmd};
        div.innerHTML = `
            <div class="hist-left"><span class="icon">${iconOvr||meta.icon}</span><span class="name">${cmd.replace(/CMD_|Skill_/g,'')}</span></div>
            <span class="src">${src}</span>
        `;
        this.box.insertBefore(div, this.box.firstChild);
        if(this.box.children.length > 8) this.box.lastChild.remove();
    },
    showToast(msg) {
        this.toast.innerHTML = `<div class="log-msg">${msg}</div>`;
        setTimeout(()=>{ if(this.toast.firstChild) this.toast.firstChild.style.opacity=1; }, 10);
        setTimeout(()=>{ if(this.toast.firstChild) this.toast.firstChild.remove(); }, 1000);
    }
};

// Help Modal
const modal = document.getElementById('help-modal');
document.getElementById('btn-help').onclick = () => modal.style.display = 'flex';
document.getElementById('btn-close-help').onclick = () => modal.style.display = 'none';
modal.onclick = (e) => { if(e.target===modal) modal.style.display='none'; };

// Bootstrap
document.getElementById('btn-start').onclick = async () => {
    try{ await document.documentElement.requestFullscreen(); await screen.orientation.lock('landscape'); }catch(e){}
    document.getElementById('start-overlay').style.display='none';
    InputSystem.init(); TouchInput.init(); Game.init();
};
</script>
</body>
</html>