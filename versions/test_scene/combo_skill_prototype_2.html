<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>v17 Prototype: Input & Combo System</title>
    <style>
        /* --- Âü∫Á°ÄÁéØÂ¢É --- */
        body { margin: 0; background: #222; overflow: hidden; font-family: 'Courier New', monospace; user-select: none; touch-action: none; color: #fff; }
        #game-container { position: relative; width: 100vw; height: 100vh; overflow: hidden; }
        canvas { display: block; width: 100%; height: 100%; }

        /* --- UI: Êåá‰ª§ÂéÜÂè≤ (Â∑¶‰æß) --- */
        #ui-history {
            position: absolute; top: 60px; left: 10px; width: 220px; bottom: 200px;
            pointer-events: none; display: flex; flex-direction: column-reverse; /* ÊúÄÊñ∞Âú®‰∏ã(Êàñ‰∏äÔºåÂèñÂÜ≥‰∫éÊèíÂÖ•È°∫Â∫è) */
            justify-content: flex-start; gap: 5px;
            overflow: hidden;
        }
        .hist-item {
            background: rgba(0,0,0,0.6); border-left: 4px solid #555;
            padding: 8px; font-size: 12px; position: relative;
            transition: all 0.2s; opacity: 0; transform: translateX(-20px);
            animation: slideIn 0.2s forwards;
        }
        @keyframes slideIn { to { opacity: 1; transform: translateX(0); } }
        
        .hist-item.type-raw { border-color: #888; }
        .hist-item.type-move { border-color: #00eaff; background: linear-gradient(90deg, rgba(0,234,255,0.2), transparent); }
        .hist-item.type-fail { border-color: #ff0055; opacity: 0.5; }

        .icon { display: inline-block; width: 20px; text-align: center; font-weight: bold; margin-right: 5px; }
        .cmd-name { font-weight: bold; font-size: 14px; display: block; }
        .cmd-source { font-size: 10px; color: #aaa; display: block; margin-top: 2px; }

        /* --- UI: ÂÖ®Â±ÄÊó•Âøó (‰∏≠‰∏ã) --- */
        #ui-log {
            position: absolute; bottom: 20%; left: 50%; transform: translateX(-50%);
            text-align: center; pointer-events: none;
            text-shadow: 0 0 5px #000;
        }
        .log-msg {
            font-size: 20px; color: #ffeb3b; font-weight: 900; 
            margin-top: 5px; opacity: 0; transition: opacity 0.5s;
        }

        /* --- UI: Ëß¶Êë∏Êéß‰ª∂ --- */
        #controls-layer { position: absolute; inset: 0; pointer-events: none; }
        
        /* ÊëáÊùÜ */
        .joystick-base {
            position: absolute; bottom: 40px; left: 40px; width: 140px; height: 140px;
            border-radius: 50%; border: 2px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.3); pointer-events: auto;
        }
        .joy-thumb {
            position: absolute; top: 50%; left: 50%; width: 50px; height: 50px;
            margin: -25px; background: rgba(0, 234, 255, 0.5); border-radius: 50%;
            transform: translate(0,0); transition: transform 0.05s;
        }
        .joy-slot {
            position: absolute; width: 10px; height: 10px; background: #555; border-radius: 50%;
            top: 50%; left: 50%; margin: -5px; transform-origin: 0 0;
        }
        
        /* ÊâãÂäøÂå∫ */
        .gesture-zone {
            position: absolute; bottom: 0; right: 0; width: 50%; height: 80%;
            border-left: 1px dashed rgba(255,255,255,0.1);
            background: rgba(255,0,0,0.05); pointer-events: auto;
        }
        .gesture-hint {
            position: absolute; bottom: 10px; right: 10px; color: #555; font-size: 10px; text-align: right;
        }
        
        /* Ë∞ÉËØï‰ø°ÊÅØ */
        #debug-info { position: absolute; top: 10px; right: 10px; text-align: right; font-size: 12px; color: #888; }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="canvas"></canvas>
    
    <!-- UI -->
    <div id="ui-history"></div>
    <div id="ui-log"></div>
    <div id="debug-info">
        v17 Prototype<br>
        WASD + J(Atk) K(Jump) L(Dash) O(Ult)<br>
        S+L = Flash Slash
    </div>

    <!-- Controls -->
    <div id="controls-layer">
        <div class="joystick-base" id="stick-base">
            <div class="joy-thumb" id="stick-thumb"></div>
            <!-- 8 slots gen by JS -->
        </div>
        <div class="gesture-zone" id="gesture-pad">
            <div class="gesture-hint">SWIPE / TAP HERE</div>
        </div>
    </div>
</div>

<script>
/**
 * =========================================
 * 1. CONFIG: COMMAND MANIFEST (Êï∞ÊçÆÈ©±Âä®Ê†∏ÂøÉ)
 * =========================================
 */
const COMMAND_MANIFEST = [
    // --- Áä∂ÊÄÅÁ±ªÊåá‰ª§ (ÊåÅÁª≠ÁîüÊïà) ---
    { id: 'CMD_MOVE_LEFT',  type: 'STATE', icon: '‚¨Ö',  triggers: [{hw:'KEY', code:'KeyA'}, {hw:'STICK', dir:'LEFT'}] },
    { id: 'CMD_MOVE_RIGHT', type: 'STATE', icon: '‚û°',  triggers: [{hw:'KEY', code:'KeyD'}, {hw:'STICK', dir:'RIGHT'}] },
    { id: 'CMD_CROUCH',     type: 'STATE', icon: '‚¨á',  triggers: [{hw:'KEY', code:'KeyS'}, {hw:'STICK', dir:'DOWN'}] },
    
    // --- Âä®‰ΩúÁ±ªÊåá‰ª§ (‰∏ÄÊ¨°ÊÄßËß¶Âèë) ---
    { id: 'CMD_JUMP',       type: 'TRIG',  icon: '‚¨Ü',  triggers: [{hw:'KEY', code:'KeyK'}, {hw:'GESTURE', id:'SWIPE_UP'}] },
    { id: 'CMD_ATK',        type: 'TRIG',  icon: '‚öîÔ∏è', triggers: [{hw:'KEY', code:'KeyJ'}, {hw:'GESTURE', id:'TAP'}] },
    { id: 'CMD_ULT',        type: 'TRIG',  icon: '‚≠ï',  triggers: [{hw:'KEY', code:'KeyO'}, {hw:'GESTURE', id:'SWIPE_DOWN'}] },
    
    // --- ÊäÄËÉΩÊåá‰ª§ (‰∏ä‰∏ãÊñáÊïèÊÑü) ---
    // 1. Â∑¶ÂÜ≤Âà∫
    { 
        id: 'CMD_DASH_L', type: 'TRIG', icon: '‚è™', 
        triggers: [
            { hw: 'GESTURE', id: 'SWIPE_LEFT' },      // Ëß¶Â±èÁõ¥Êé•Â∑¶Êªë
            { hw: 'KEY', code: 'KeyL', mod: 'KeyA' }  // ÈîÆÁõò L + Êåâ‰ΩèA
        ] 
    },
    // 2. Âè≥ÂÜ≤Âà∫
    { 
        id: 'CMD_DASH_R', type: 'TRIG', icon: '‚è©', 
        triggers: [
            { hw: 'GESTURE', id: 'SWIPE_RIGHT' },     // Ëß¶Â±èÁõ¥Êé•Âè≥Êªë
            { hw: 'KEY', code: 'KeyL', mod: 'KeyD' }  // ÈîÆÁõò L + Êåâ‰ΩèD
        ] 
    },
    // 3. Ëá™Âä®/ÂâçÂêëÂÜ≤Âà∫ (ÂΩìÊ≤°ÊåâÊñπÂêëÈîÆÊó∂)
    { 
        id: 'CMD_DASH_AUTO', type: 'TRIG', icon: 'üöÄ', 
        triggers: [
            { hw: 'KEY', code: 'KeyL', mod: null }    // ÈîÆÁõòÂçïÊåâ L
        ] 
    }
];

/**
 * =========================================
 * 2. SYSTEM: INPUT PROCESSOR (ËæìÂÖ•ÂΩí‰∏ÄÂåñ)
 * =========================================
 */
const InputSystem = {
    heldKeys: new Set(), // ÂΩìÂâçÊåâ‰∏ãÁöÑÁâ©ÁêÜÊåâÈîÆ
    virtualState: {      // ËôöÊãüÁä∂ÊÄÅ
        moveX: 0,        // -1, 0, 1
        crouch: false
    }, 
    
    init() {
        // Keyboard Listeners
        window.addEventListener('keydown', e => {
            if(e.repeat) return;
            this.heldKeys.add(e.code);
            this.processInput('KEY', e.code);
            this.updateVirtualState();
        });
        window.addEventListener('keyup', e => {
            this.heldKeys.delete(e.code);
            this.updateVirtualState();
        });
        
        // Touch Listeners (Joystick & Gesture) -> setup in UI section
    },

    // Ê†∏ÂøÉÂ§ÑÁêÜÂáΩÊï∞ÔºöÊü•Ë°®ÂåπÈÖç
    processInput(hwType, hwId) {
        // ÈÅçÂéÜÊâÄÊúâÂèØËÉΩÁöÑÊåá‰ª§
        for(let cmd of COMMAND_MANIFEST) {
            // ÈÅçÂéÜËØ•Êåá‰ª§ÁöÑÊâÄÊúâËß¶ÂèëÊù°‰ª∂
            for(let trig of cmd.triggers) {
                // 1. Á°¨‰ª∂Á±ªÂûã‰∏éIDÂåπÈÖç
                if(trig.hw === hwType && (trig.code === hwId || trig.id === hwId || trig.dir === hwId)) {
                    
                    // 2. Ê£ÄÊü•‰øÆÈ•∞ÈîÆ (Modifier)
                    let modMatch = true;
                    if(trig.hw === 'KEY') {
                        if(trig.mod) {
                            // ÂøÖÈ°ªÊåâ‰∏ã‰øÆÈ•∞ÈîÆ
                            if(!this.heldKeys.has(trig.mod)) modMatch = false;
                        } else if (trig.mod === null) {
                            // ÂøÖÈ°ª *‰∏ç* Êåâ‰∏ã‰ªª‰ΩïÊñπÂêë‰øÆÈ•∞ÈîÆ (ÈíàÂØπ Auto Dash)
                            // ËøôÈáåÁÆÄÂåñÈÄªËæëÔºöÂ¶ÇÊûúÂÆö‰πâ‰∫Ü mod: nullÔºåÊÑèÂë≥ÁùÄÂÆÉÊòØ Default Fallback
                            // ‰ΩÜÊàë‰ª¨ÈúÄË¶ÅÁ°Æ‰øùÂÉè A+L ËøôÊ†∑ÁöÑÈ´ò‰ºòÂÖàÁ∫ßÂÖàË¢´ÂåπÈÖç„ÄÇ
                            // Âú®ËøôÈáåÔºåÊàë‰ª¨ÂèØ‰ª•ÁÆÄÂçïÁöÑ‰æùËµñ manifest ÁöÑÈ°∫Â∫èÔºö
                            // ÂøÖÈ°ªÂÖàÂÆö‰πâÊúâ mod ÁöÑÔºåÂÜçÂÆö‰πâ mod null ÁöÑ„ÄÇ
                            // ÊàñËÄÖÔºåÂú®ËøôÈáåÊòæÂºèÊ£ÄÊü•ÔºöÂ¶ÇÊûúÂΩìÂâçÊåâ‰∏ã‰∫Ü A Êàñ DÔºåÂàô mod:null ‰∏çÂåπÈÖç
                            if(this.heldKeys.has('KeyA') || this.heldKeys.has('KeyD')) modMatch = false;
                        }
                    }

                    if(modMatch) {
                        this.emitCommand(cmd, hwType, hwId);
                        return; // ÂåπÈÖçÂà∞‰∏Ä‰∏™Â∞±ÂÅúÊ≠¢ÔºåÈÅøÂÖç L ÂêåÊó∂Ëß¶Âèë Dash_L Âíå Dash_Auto
                    }
                }
            }
        }
    },

    // ÂèëÂ∞ÑËôöÊãüÊåá‰ª§ -> ‰º†Áªô Combo Engine
    emitCommand(cmd, sourceHw, sourceId) {
        ComboEngine.push(cmd.id, `${sourceHw}:${sourceId.replace('Key','')}`);
    },

    // Êõ¥Êñ∞ÊåÅÁª≠ÊÄßÁä∂ÊÄÅ (Move/Crouch)
    updateVirtualState() {
        // Reset
        let vx = 0;
        let down = false;

        // Keyboard Check
        if(this.heldKeys.has('KeyA')) vx -= 1;
        if(this.heldKeys.has('KeyD')) vx += 1;
        if(this.heldKeys.has('KeyS')) down = true;

        // Joystick Check (ÂêàÂπ∂Ëß¶Â±èÁä∂ÊÄÅ)
        if(TouchInput.stick.x < -0.3) vx = -1;
        if(TouchInput.stick.x > 0.3) vx = 1;
        if(TouchInput.stick.y < -0.5) down = true; // YÂêë‰∏ä‰∏∫Ê≠£? ÂæÖ‰ºöÁúãÊëáÊùÜÈÄªËæë

        this.virtualState.moveX = vx;
        this.virtualState.crouch = down;
        
        // [ÂÖ≥ÈîÆ] Â¶ÇÊûúÁä∂ÊÄÅÂèëÁîüÂèòÂåñÔºå‰πüÂèØËÉΩËßÜ‰∏∫‰∏ÄÊ¨°‚ÄúÊåá‰ª§ËæìÂÖ•‚ÄùÊé®ÂÖ• Buffer (Áî®‰∫é S+L Âà§ÂÆö)
        // ËøôÈáåÂÅö‰∏Ä‰∏™ÁÆÄÂçïÁöÑËæπÁºòÊ£ÄÊµã
        if(down && !this.lastCrouch) {
            ComboEngine.push('CMD_CROUCH', 'STATE_CHANGE');
        }
        this.lastCrouch = down;
    },
    lastCrouch: false
};

/**
 * =========================================
 * 3. ENGINE: COMBO & MOVE LOGIC (ÊêìÊãõÁ≥ªÁªü)
 * =========================================
 */
const ComboEngine = {
    buffer: [], // { id, time, source }
    timeout: 400, // ms
    timer: null,

    push(cmdId, source) {
        let now = Date.now();
        
        // Push to buffer
        this.buffer.push({ id: cmdId, time: now, source: source });
        
        // Âè™Ë¶ÅÊúâËæìÂÖ•ÔºåÂ∞±Ê∑ªÂä†‰∏ÄÊù° Raw Log
        UI.addHistory(cmdId, source, 'raw');

        // Reset Timeout
        if(this.timer) clearTimeout(this.timer);
        this.timer = setTimeout(() => this.resolveBuffer(), this.timeout);

        // Immediate Check (Eager Evaluation)
        this.checkMoves();
    },

    // Ê£ÄÊü•ÊãõÂºèË°®
    checkMoves() {
        if(this.buffer.length === 0) return;

        // Ëé∑ÂèñÊúÄËøëÁöÑÊåá‰ª§Â∫èÂàó
        let len = this.buffer.length;
        let last = this.buffer[len-1];
        let prev = len >= 2 ? this.buffer[len-2] : null;

        // --- ÊãõÂºè 1: Flash Slash (Èó™ÂàÄ) ---
        // Â∫èÂàó: [CROUCH, DASH_*]
        if(prev && prev.id === 'CMD_CROUCH' && last.id.startsWith('CMD_DASH')) {
            this.executeMove('FLASH SLASH', '‚ö°', last.source);
            this.buffer = []; // Clear
            return;
        }

        // --- ÊãõÂºè 2: Directional Dash (ÂÜ≤Âà∫) ---
        // Â∫èÂàó: [DASH_*] (ÂçïÈîÆËß¶ÂèëÔºå‰ΩÜÂ¶ÇÊûúÊòØÈó™ÂàÄÁöÑ‰∏ÄÈÉ®ÂàÜ‰ºöË¢´‰∏äÈù¢Êã¶Êà™)
        // ËøôÊòØ‰∏Ä‰∏™ tricky ÁöÑÂú∞ÊñπÔºöÂ¶ÇÊûúÊàëÊåâ LÔºåÊàëË¶ÅÁ´ãÂàªÂÜ≤Âà∫ÔºåËøòÊòØÁ≠âÂæÖ S+LÔºü
        // Âä®‰ΩúÊ∏∏Êàè‰∏≠ÂÜ≤Âà∫ÈÄöÂ∏∏ÊòØÁ´ãÂàªÁöÑ„ÄÇS+L ÈúÄË¶Å S ÂÖàÊåâ„ÄÇ
        // ÊâÄ‰ª•ÔºåÂ¶ÇÊûú Buffer Âè™Êúâ [DASH]ÔºåÁ´ãÂàªÊâßË°åÂÜ≤Âà∫„ÄÇ
        if(last.id.startsWith('CMD_DASH')) {
            // ÈúÄË¶ÅÂà§Êñ≠Ââç‰∏Ä‰∏™ÊòØÂê¶ÊòØ CrouchÔºåÂ¶ÇÊûúÊòØÔºåÂ∑≤ÁªèÂú®‰∏äÈù¢ return ‰∫Ü
            // ÊâÄ‰ª•ËøôÈáåÂ∞±ÊòØÂçïÁ∫ØÁöÑ Dash
            let dir = last.id === 'CMD_DASH_L' ? -1 : (last.id === 'CMD_DASH_R' ? 1 : 0);
            this.executeMove('DASH', '>>', last.source, { dir: dir });
            this.buffer = [];
            return;
        }

        // --- ÊãõÂºè 3: Attack / Jump / Ult ---
        // Ëøô‰∫õÈÄöÂ∏∏ÊòØÁ´ãÂç≥Ëß¶Âèë
        if(last.id === 'CMD_ATK') {
            this.executeMove('ATTACK', '‚öîÔ∏è', last.source);
            this.buffer = []; return;
        }
        if(last.id === 'CMD_JUMP') {
            this.executeMove('JUMP', '‚¨Ü', last.source);
            this.buffer = []; return;
        }
        if(last.id === 'CMD_ULT') {
            this.executeMove('ULTIMATE', '‚≠ï', last.source);
            this.buffer = []; return;
        }
    },

    resolveBuffer() {
        // Ë∂ÖÊó∂ÁªìÁÆóÔºöÈÄöÂ∏∏Áî®‰∫éÊ∏ÖÈô§ÈÇ£‰∫õÊ≤°ËÉΩËøûÊàêÊãõÂºèÁöÑÊÆãÁïôÁä∂ÊÄÅ
        if(this.buffer.length > 0) {
            // UI.addHistory('TIMEOUT', '-', 'fail');
            this.buffer = [];
        }
    },

    executeMove(name, icon, source, params={}) {
        // 1. UI Feedback
        UI.addHistory(name, source, 'move', icon);
        UI.showToast(name);
        
        // 2. Game Logic
        Game.triggerAction(name, params);
    }
};

/**
 * =========================================
 * 4. TOUCH INPUT (Joystick & Gesture)
 * =========================================
 */
const TouchInput = {
    stick: { x: 0, y: 0 },
    
    init() {
        // --- Joystick ---
        const base = document.getElementById('stick-base');
        const thumb = document.getElementById('stick-thumb');
        
        // Gen slots visuals
        for(let i=0; i<8; i++) {
            let d = document.createElement('div');
            d.className = 'joy-slot';
            d.style.transform = `rotate(${i*45}deg) translate(65px)`;
            base.appendChild(d);
        }

        const handleStick = (t) => {
            const rect = base.getBoundingClientRect();
            const cx = rect.left + rect.width/2;
            const cy = rect.top + rect.height/2;
            let dx = t.clientX - cx;
            let dy = t.clientY - cy;
            
            // Limit
            let dist = Math.sqrt(dx*dx+dy*dy);
            let max = 40;
            if(dist>max) { dx *= max/dist; dy *= max/dist; }
            
            thumb.style.transform = `translate(${dx}px, ${dy}px)`;
            
            // Normalize
            this.stick.x = dx / max;
            this.stick.y = -dy / max; // Y up is positive in logic, usually
            
            // Map to CMD triggers
            // ÁÆÄÂçïÂ§ÑÁêÜÔºöÊØèÂ∏ßÊõ¥Êñ∞ InputSystem ‰ºöËØªÂèñ stick.x/y
            // ‰ΩÜÈúÄË¶ÅËß¶Âèë processInput ‰ª•Â§ÑÁêÜ STATE Êåá‰ª§
            if(this.stick.x < -0.5) InputSystem.processInput('STICK', 'LEFT');
            if(this.stick.x > 0.5) InputSystem.processInput('STICK', 'RIGHT');
            if(this.stick.y < -0.5) InputSystem.processInput('STICK', 'DOWN'); // Screen Down is Logic Y negative? Let's fix axis
            // Screen Y down is +, Logic Y down usually -. 
            // My code above: dy is screen delta. if pull down, dy > 0.
            // this.stick.y = -dy/max => pull down -> y negative.
            // Config: triggers: {hw:'STICK', dir:'DOWN'}
            // So if stick.y < -0.5 -> DOWN. Correct.
            
            InputSystem.updateVirtualState();
        };

        base.addEventListener('touchmove', e => { e.preventDefault(); handleStick(e.changedTouches[0]); });
        base.addEventListener('touchend', e => { 
            e.preventDefault(); 
            thumb.style.transform = `translate(0,0)`;
            this.stick.x = 0; this.stick.y = 0;
            InputSystem.updateVirtualState();
        });
        base.addEventListener('touchstart', e => { e.preventDefault(); handleStick(e.changedTouches[0]); });


        // --- Gestures ---
        const pad = document.getElementById('gesture-pad');
        let start = {x:0, y:0, t:0};
        
        pad.addEventListener('touchstart', e => {
            e.preventDefault();
            let t = e.changedTouches[0];
            start = {x: t.clientX, y: t.clientY, t: Date.now()};
        });
        
        pad.addEventListener('touchend', e => {
            e.preventDefault();
            let t = e.changedTouches[0];
            let dx = t.clientX - start.x;
            let dy = t.clientY - start.y;
            let dt = Date.now() - start.t;
            
            if(dt > 400) return; // Too slow
            
            let absX = Math.abs(dx);
            let absY = Math.abs(dy);
            
            if(absX < 20 && absY < 20) {
                InputSystem.processInput('GESTURE', 'TAP');
            } else if (absY > absX) {
                if(dy < -50) InputSystem.processInput('GESTURE', 'SWIPE_UP');
                if(dy > 50) InputSystem.processInput('GESTURE', 'SWIPE_DOWN');
            } else {
                if(dx < -50) InputSystem.processInput('GESTURE', 'SWIPE_LEFT');
                if(dx > 50) InputSystem.processInput('GESTURE', 'SWIPE_RIGHT');
            }
        });
    }
};

/**
 * =========================================
 * 5. MOCK GAME & RENDERER (ËßÜËßâÈ™åËØÅ)
 * =========================================
 */
const UI = {
    historyBox: document.getElementById('ui-history'),
    logBox: document.getElementById('ui-log'),
    
    addHistory(cmd, source, type, iconOverride) {
        let div = document.createElement('div');
        div.className = `hist-item type-${type}`;
        
        // Find command meta
        let meta = COMMAND_MANIFEST.find(c => c.id === cmd) || { icon: '?', id: cmd };
        let icon = iconOverride || meta.icon;
        
        div.innerHTML = `
            <span class="icon">${icon}</span>
            <span class="cmd-name">${cmd.replace('CMD_','').replace('Skill_','')}</span>
            <span class="cmd-source">${source}</span>
        `;
        
        // Insert at top
        this.historyBox.insertBefore(div, this.historyBox.firstChild);
        
        // Limit
        if(this.historyBox.children.length > 8) {
            this.historyBox.lastChild.remove();
        }
    },
    
    showToast(msg) {
        let el = document.createElement('div');
        el.className = 'log-msg';
        el.innerText = `EVENT: ${msg}`;
        this.logBox.appendChild(el);
        
        // Anim
        requestAnimationFrame(()=> el.style.opacity = 1);
        setTimeout(() => {
            el.style.opacity = 0;
            setTimeout(()=>el.remove(), 500);
        }, 1000);
    }
};

const Game = {
    player: { x: 200, y: 300, w: 40, h: 40, color: '#00eaff', vx: 0, vy: 0 },
    enemy: { x: 600, y: 300, w: 40, h: 40, color: '#ff0055' },
    
    init() {
        const cvs = document.getElementById('canvas');
        cvs.width = window.innerWidth;
        cvs.height = window.innerHeight;
        this.ctx = cvs.getContext('2d');
        this.loop();
    },
    
    triggerAction(moveName, params) {
        const p = this.player;
        if(moveName === 'JUMP') p.vy = -15;
        if(moveName === 'DASH') {
            let dir = params.dir;
            if(dir === 0) dir = this.enemy.x > p.x ? 1 : -1; // Auto target
            p.vx = 30 * dir; // Burst speed
        }
        if(moveName === 'FLASH SLASH') {
            p.x = this.enemy.x - 50; // Teleport check
            p.vx = 0;
        }
    },
    
    loop() {
        const ctx = this.ctx;
        const p = this.player;
        
        // Physics
        let moveDir = InputSystem.virtualState.moveX;
        if(Math.abs(p.vx) < 20) p.vx = moveDir * 5; // Normal move
        else p.vx *= 0.9; // Dash friction
        
        p.vy += 0.8; // Gravity
        p.x += p.vx;
        p.y += p.vy;
        
        // Floor
        if(p.y > 400) { p.y = 400; p.vy = 0; }
        
        // Render
        ctx.fillStyle = '#222';
        ctx.fillRect(0,0, ctx.canvas.width, ctx.canvas.height);
        
        // Floor Line
        ctx.strokeStyle = '#555'; ctx.beginPath(); ctx.moveTo(0, 440); ctx.lineTo(2000, 440); ctx.stroke();

        // Enemy
        ctx.fillStyle = this.enemy.color;
        ctx.fillRect(this.enemy.x, this.enemy.y, this.enemy.w, this.enemy.h);
        ctx.fillStyle = '#fff'; ctx.fillText('ENEMY', this.enemy.x, this.enemy.y - 10);
        
        // Player
        ctx.fillStyle = InputSystem.virtualState.crouch ? '#0088aa' : p.color; // Crouch dims color
        // Flash Slash Visual Hint (if S held)
        if(InputSystem.virtualState.crouch) {
            ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.strokeRect(p.x-5, p.y+10, p.w+10, p.h-10);
        }
        
        let h = InputSystem.virtualState.crouch ? 20 : 40;
        ctx.fillRect(p.x, p.y + (40-h), p.w, h);
        
        // Debug Info
        ctx.fillStyle = '#aaa';
        ctx.fillText(`STATE: MoveX=${InputSystem.virtualState.moveX} Crouch=${InputSystem.virtualState.crouch}`, 10, 20);
        
        requestAnimationFrame(() => this.loop());
    }
};

// --- BOOTSTRAP ---
InputSystem.init();
TouchInput.init();
Game.init();

</script>
</body>
</html>