// æ–‡ä»¶: gradle/publish-template.gradle
import java.security.MessageDigest
import groovy.json.JsonOutput

// ============================================================
// æ¨¡æ¿å‘å¸ƒæµæ°´çº¿
// ç”¨æ³•: gradlew publishTemplate -Ptarget=BigDemo
// ============================================================

ext {
	CHUNK_SIZE = 18 * 1024 * 1024 // 18 MB
	// æºä½ç½®ï¼šå¼€å‘ç¯å¢ƒçš„æ¨¡æ¿ç›®å½•
	TEMPLATES_ROOT = file("GDEngine/InternalProjectTemplates")
	BUILD_TMP = file("build/tmp_tpl_publish")
	DIST_ROOT = file("dist/templates") // äº§ç‰©å­˜æ”¾: dist/templates/<TemplateName>/
}

tasks.register('publishTemplate') {
	group = 'gdengine-publish'
	description = 'Package, Split and Manifest a specific template. Usage: -Ptarget=TemplateName'

	doLast {
		// 1. è·å–ç›®æ ‡å‚æ•°
		if (!project.hasProperty('target')) {
			throw new GradleException("è¯·æŒ‡å®šç›®æ ‡æ¨¡æ¿! ç”¨æ³•: gradlew publishTemplate -Ptarget=TemplateName")
		}
		String targetName = project.property('target')
		File sourceDir = new File(TEMPLATES_ROOT, targetName)

		if (!sourceDir.exists()) {
			throw new GradleException("æ¨¡æ¿ç›®å½•ä¸å­˜åœ¨: ${sourceDir.absolutePath}")
		}

		println "ğŸ“¦ æ­£åœ¨å¤„ç†æ¨¡æ¿: ${targetName}"

		// 2. å‡†å¤‡ç›®å½•
		BUILD_TMP.deleteDir()
		BUILD_TMP.mkdirs()

		File targetDistDir = new File(DIST_ROOT, targetName)
		if (targetDistDir.exists()) targetDistDir.deleteDir()
		targetDistDir.mkdirs()

		// 3. æ‰“åŒ… Zip
		println "   -> æ­£åœ¨å‹ç¼©..."
		File zipFile = new File(BUILD_TMP, "${targetName}.zip")

		ant.zip(destfile: zipFile, basedir: sourceDir)

		// [ä¿®å¤] ä½¿ç”¨ String.format æ›¿ä»£ BigDecimal.format()
		def sizeMb = zipFile.length() / (1024.0 * 1024.0)
		println "   -> å‹ç¼©å®Œæˆ: ${String.format('%.2f', sizeMb)} MB"

		// 4. åˆ‡åˆ†
		println "   -> æ­£åœ¨åˆ‡åˆ† (æ¯å· 18MB)..."
		def partsList = []
		def buffer = new byte[CHUNK_SIZE]
		int partIndex = 0

		zipFile.withInputStream { ins ->
			while (true) {
				int bytesRead = ins.read(buffer)
				if (bytesRead <= 0) break

				// å‘½å: BigDemo.part000.zip (ä¿ç•™ .zip åç¼€ä»¥é€‚é… CDN)
				String partName = String.format("${targetName}.part%03d.zip", partIndex)
				File partFile = new File(targetDistDir, partName)

				partFile.withOutputStream { outs ->
					outs.write(buffer, 0, bytesRead)
				}

				// MD5
				String md5 = generateMD5(partFile)

				partsList << [
					index: partIndex,
					file: partName,
					md5: md5,
					size: partFile.length()
				]

				def partSize = partFile.length() / (1024.0 * 1024.0)
				println "      Generated: ${partName} (${String.format('%.2f', partSize)} MB)"
				partIndex++
			}
		}

		// 5. ç”Ÿæˆ Manifest
		def manifest = [
			id: targetName, // æ¨¡æ¿ID
			name: "${targetName}.zip", // åˆå¹¶åçš„æ–‡ä»¶å
			totalSize: zipFile.length(),
			version: "1.0",
			updatedAt: new Date().format("yyyy-MM-dd HH:mm:ss", TimeZone.getTimeZone("Asia/Shanghai")),
			parts: partsList
		]

		File jsonFile = new File(targetDistDir, "manifest.json")
		jsonFile.text = JsonOutput.prettyPrint(JsonOutput.toJson(manifest))

		println "âœ… å‘å¸ƒå®Œæˆï¼äº§ç‰©ä½äº: ${targetDistDir}"
		println "ğŸš€ è¯·å°† dist/ ç›®å½•æäº¤åˆ° GitHub"
	}
}

def generateMD5(File file) {
	MessageDigest digest = MessageDigest.getInstance("MD5")
	file.withInputStream { is ->
		byte[] buffer = new byte[8192]
		int read
		while ((read = is.read(buffer)) > 0) digest.update(buffer, 0, read)
	}
	return digest.digest().encodeHex().toString()
}