// ============================================================
// ÂÖ®Ëá™Âä®ÂèëÂ∏ÉÊµÅÊ∞¥Á∫ø (Auto Release Pipeline) - V3.1
// [‰øÆÊ≠£] Tag ‰∏çÂ∏¶ 'v' ÂâçÁºÄÔºåÂÆåÂÖ®ÈÅµÂæ™ËØ≠‰πâÂåñÁâàÊú¨ (x.y.z)
// ============================================================

import java.nio.charset.StandardCharsets

ext {
    DIST_RELEASE_DIR = file("${rootProject.rootDir}/dist/release")
    OUTPUTS_DIR = file("${rootProject.rootDir}/outputs")
    RELEASE_NOTE_FILE = file("${rootProject.rootDir}/RELEASE_NOTE.md")
    PROP_FILE = file("${rootProject.rootDir}/gradle.properties")
}

// --- [ÈÖçÁΩÆÈò∂ÊÆµÁâàÊú¨Ê≥®ÂÖ•] ---
String targetVersion = null

// 1. ‰ºòÂÖàÊ£ÄÊü•ÂëΩ‰ª§Ë°åÂèÇÊï∞ -PtargetVer=...
if (project.hasProperty("targetVer")) {
    targetVersion = project.property("targetVer")
    println "üéØ [ÈÖçÁΩÆ] Ê£ÄÊµãÂà∞ÂëΩ‰ª§Ë°åÂèÇÊï∞ÁâàÊú¨: ${targetVersion}"
} 
// 2. Âê¶ÂàôËØªÂèñ RELEASE_NOTE.md
else if (RELEASE_NOTE_FILE.exists()) {
    def lines = RELEASE_NOTE_FILE.readLines("UTF-8")
    if (!lines.isEmpty()) {
        // ÂéªÊéâÂèØËÉΩÂ≠òÂú®ÁöÑ # Âè∑ÂíåÁ©∫Ê†º
        def rawVer = lines[0].replace("#", "").trim()
        // ÁÆÄÂçïÊ†°È™åÊòØÂê¶ÂÉè‰∏™ÁâàÊú¨Âè∑
        if (rawVer.matches(/\d+(\.\d+)+.*/)) {
            targetVersion = rawVer
            println "üìù [ÈÖçÁΩÆ] ‰ªéÂèëÂ∏ÉÊñáÊ°£ËØªÂèñÁâàÊú¨: ${targetVersion}"
        }
    }
}

// Ë¶ÜÁõñÂΩìÂâçËøêË°åÊó∂ÁöÑÁâàÊú¨ÈÖçÁΩÆ
if (targetVersion != null) {
    allprojects {
        version = targetVersion
        project.version = targetVersion
    }
    rootProject.ext.projectVersion = targetVersion
}

// ============================================================

tasks.register('publishExecutables') {
    group = 'gdengine-publish'
    description = '‰∏ÄÈîÆÂèëÂ∏ÉÔºöÊîπÁâàÊú¨->ÊûÑÂª∫->ÂΩíÊ°£->GitÊèê‰∫§->Êé®ÈÄÅ'

    // 1. ÁéØÂ¢ÉÂáÜÂ§á
    doFirst {
        if (targetVersion == null) {
            throw new GradleException("‚ùå Êó†Ê≥ïÁ°ÆÂÆöÂèëÂ∏ÉÁâàÊú¨ÔºÅËØ∑Á°Æ‰øù RELEASE_NOTE.md Á¨¨‰∏ÄË°å‰∏∫ÁâàÊú¨Âè∑ (Â¶Ç 1.10.12.21)")
        }
        
        println "üöÄ [1/6] ÂºÄÂßãÂèëÂ∏ÉÊµÅÁ®ã: ${targetVersion}" // [‰øÆÊ≠£] ÂéªÊéâ V ÂâçÁºÄÊòæÁ§∫
        
        // Êõ¥Êñ∞ gradle.properties (ÊåÅ‰πÖÂåñ)
        updatePropertiesFile(targetVersion)
        
        // Ê∏ÖÁêÜÂèëÂ∏ÉÁõÆÂΩï
        delete DIST_RELEASE_DIR
        DIST_RELEASE_DIR.mkdirs()
    }

    // 2. ‰æùËµñÊûÑÂª∫
    // Âº∫Âà∂ÁºñËØë Core ‰ª•Êõ¥Êñ∞ BuildConfig/README
    dependsOn ":core:compileJava"
    dependsOn rootProject.tasks.named('generateChangelog')
    dependsOn ":core:copyEngineLibs"
    dependsOn ":core:packageEngineCore"
    dependsOn ":lwjgl3:jar"
    dependsOn ":android:assembleRelease"

    // 3. ÂΩíÊ°£‰∏é Git Êìç‰Ωú
    doLast {
        println "üì¶ [3/6] ÂΩíÊ°£‰∫ßÁâ©..."
        
        // [‰øÆÊ≠£] Êñá‰ª∂Âêç‰æùÁÑ∂‰øùÁïô V ÂâçÁºÄ (ËøôÊòØÊñá‰ª∂ÂêçËßÑËåÉÔºå‰∏ç‰ªÖÊòØ Tag ËßÑËåÉ)
        // ‰æãÂ¶Ç: GDEngine_V1.10.12.21.apk
        def expectedApk = "GDEngine_V${targetVersion}.apk"
        def expectedJar = "GDEngine_V${targetVersion}.jar"

        copy {
            from OUTPUTS_DIR
            into DIST_RELEASE_DIR
            include expectedJar
            include expectedApk
            include "GDEngine_V${targetVersion}.exe"
        }

        File distApk = new File(DIST_RELEASE_DIR, expectedApk)
        if (!distApk.exists()) throw new GradleException("‚ùå APK ‰∫ßÁâ©Êú™ÊâæÂà∞: ${expectedApk}")
        
        println "‚úÖ ‰∫ßÁâ©Â∑≤Â∞±Áª™: dist/release/ (APK & JAR)"

        // --- Git Ëá™Âä®Âåñ ---
        // Ê≥®ÊÑèÔºöGit Tag ‰∏çÂ∏¶ 'v'
        
        println "üêô [4/6] ÊâßË°å Git Êèê‰∫§..."
        runCmd("git add .") 
        runCmd("git commit -m \"chore: release ${targetVersion}\"")

        println "üè∑Ô∏è [5/6] Êâì Tag..."
        // Â∞ùËØïÂà†Èô§Êú¨Âú∞ÂêåÂêç tag
        try { runCmd("git tag -d ${targetVersion}") } catch(e){}
        
        // [‰øÆÊ≠£] Tag ÂêçÁß∞‰∏çÂ∏¶ vÔºåÁõ¥Êé•Áî® targetVersion
        // -F ËØªÂèñ RELEASE_NOTE.md ‰Ωú‰∏∫ Tag ËØ¥Êòé
        runCmd("git tag -a ${targetVersion} -F RELEASE_NOTE.md")

        println "üöÄ [6/6] Êé®ÈÄÅÂà∞ËøúÁ®ã‰ªìÂ∫ì..."
        runCmd("git push origin main") 
        // [‰øÆÊ≠£] Êé®ÈÄÅ‰∏çÂ∏¶ v ÁöÑ Tag
        runCmd("git push origin ${targetVersion}")

        println "\nüéâüéâüéâ ÂèëÂ∏ÉÂÆåÊàêÔºÅÁâàÊú¨: ${targetVersion} üéâüéâüéâ"
    }
}

// --- ËæÖÂä©ÊñπÊ≥ï (‰øùÊåÅ‰∏çÂèò) ---
def updatePropertiesFile(String newVer) {
    if (!PROP_FILE.exists()) return
    def lines = PROP_FILE.readLines("UTF-8")
    def outLines = []
    boolean updated = false
    for (String line : lines) {
        if (line.trim().startsWith("projectVersion")) {
            outLines.add("projectVersion=${newVer}")
            updated = true
        } else {
            outLines.add(line)
        }
    }
    if (updated) {
        PROP_FILE.withWriter("UTF-8") { writer -> outLines.forEach { writer.writeLine(it) } }
        println "üíæ gradle.properties Â∑≤Êõ¥Êñ∞‰∏∫ ${newVer}"
    }
}

def runCmd(String cmd) {
    println "   > ${cmd}"
    def isWin = System.getProperty("os.name").toLowerCase().contains("windows")
    def proc = isWin ? ["cmd", "/c", cmd].execute(null, rootProject.rootDir) : ["bash", "-c", cmd].execute(null, rootProject.rootDir)
    proc.waitFor()
    if (proc.exitValue() != 0) {
        println "‚ùå ÂëΩ‰ª§ÊâßË°åÂ§±Ë¥•: ${cmd}"
        println proc.err.text
        throw new GradleException("Git Êìç‰ΩúÂ§±Ë¥•")
    }
}