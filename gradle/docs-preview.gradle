import com.sun.net.httpserver.HttpServer
import com.sun.net.httpserver.HttpHandler
import com.sun.net.httpserver.HttpExchange
import java.net.InetSocketAddress
import java.nio.file.Files
import java.nio.file.Path
import java.nio.file.Paths

tasks.register('previewDocs') {
	group = "gdengine"
	description = "Start a local web server to preview documentation"

	doLast {
		int port = 8899
		String docRoot = "${rootProject.rootDir}/docs/engine_docs"

		try {
			// 1. å°è¯•ç»‘å®šç«¯å£
			HttpServer server = HttpServer.create(new InetSocketAddress(port), 0)

			// 2. é…ç½®è·¯ç”± (ä¿æŒä¸å˜)
			server.createContext("/", new HttpHandler() {
				@Override
				public void handle(HttpExchange exchange) throws IOException {
					String uri = exchange.getRequestURI().getPath()
					if (uri.equals("/")) uri = "/index.html"
					if (uri.contains("..")) { sendResponse(exchange, 403, "Forbidden"); return }

					Path filePath = Paths.get(docRoot, uri)
					File file = filePath.toFile()

					if (file.exists() && !file.isDirectory()) {
						byte[] bytes = Files.readAllBytes(filePath)
						String mime = getMimeType(uri)
						exchange.getResponseHeaders().set("Content-Type", mime)
						exchange.sendResponseHeaders(200, bytes.length)
						OutputStream os = exchange.getResponseBody()
						os.write(bytes)
						os.close()
					} else {
						sendResponse(exchange, 404, "404 Not Found: " + uri)
					}
				}
			})

			server.setExecutor(null)
			server.start()

			String url = "http://localhost:${port}/#/?v=${projectVersion}"

			println ""
			println "========================================================"
			println "ğŸŸ¢ æ–‡æ¡£æœåŠ¡å™¨å·²å¯åŠ¨ (ç«¯å£: $port)"
			println "ğŸ“‚ æ ¹ç›®å½•: $docRoot"
			println "ğŸ”— åœ°å€: $url"
			println "========================================================"
			println "âŒ¨ï¸  ã€æŒ‰å›è½¦é”®ã€‘æˆ–ã€ç‚¹å‡»IDEåœæ­¢æŒ‰é’®ã€‘å…³é—­æœåŠ¡å™¨..."
			println "========================================================"

			try {
				java.awt.Desktop.getDesktop().browse(new URI(url))
			} catch (Exception ignored) {}

			// 3. ã€æ ¸å¿ƒä¿®æ”¹ã€‘é˜»å¡ç­‰å¾…ç”¨æˆ·è¾“å…¥ï¼Œè€Œä¸æ˜¯æ­»é”
			// è¿™æ ·ä½ åœ¨æ§åˆ¶å°æŒ‰ Enter å°±èƒ½ä¼˜é›…é€€å‡ºäº†
			System.in.read()

			println "ğŸ›‘ æ­£åœ¨åœæ­¢æœåŠ¡å™¨..."
			server.stop(0)
			println "âœ… æœåŠ¡å™¨å·²å…³é—­ï¼Œç«¯å£é‡Šæ”¾ã€‚"

		} catch (java.net.BindException e) {
			println ""
			println "ğŸ”´ å¯åŠ¨å¤±è´¥ï¼šç«¯å£ $port å·²è¢«å ç”¨ï¼"
			println "   è¯·å…ˆå…³é—­æ­£åœ¨è¿è¡Œçš„ previewDocs ä»»åŠ¡ï¼Œæˆ–è€…æ‰‹åŠ¨æ€æ‰å ç”¨è¯¥ç«¯å£çš„ Java è¿›ç¨‹ã€‚"
			println "   Windowså‘½ä»¤: netstat -ano | findstr $port"
			println ""
		} catch (Exception e) {
			e.printStackTrace()
		}
	}
}

def getMimeType(String uri) {
	if (uri.endsWith(".html")) return "text/html; charset=utf-8"
	if (uri.endsWith(".css")) return "text/css"
	if (uri.endsWith(".js")) return "application/javascript; charset=utf-8"
	if (uri.endsWith(".json")) return "application/json; charset=utf-8"
	if (uri.endsWith(".png")) return "image/png"
	if (uri.endsWith(".jpg")) return "image/jpeg"
	return "application/octet-stream"
}

def sendResponse(HttpExchange exchange, int code, String msg) {
	byte[] bytes = msg.getBytes("UTF-8")
	exchange.sendResponseHeaders(code, bytes.length)
	OutputStream os = exchange.getResponseBody()
	os.write(bytes)
	os.close()
}
