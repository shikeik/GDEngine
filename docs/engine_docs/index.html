<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>GDEngine Docs</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
	<!-- 基础样式 -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsify@4/lib/themes/vue.css">

	<!-- Unity 风格侧边栏样式 (保持不变) -->
	<style>
		:root {
			--theme-color: #09D2B8;       /* Unity Teal */
			--sidebar-width: 280px;
			--folder-icon-color: #5f5f5f;
			--folder-bg-hover: #e0e0e0;
			--item-height: 30px;
		}

		/* 全局重置 */
		body { font-family: "Segoe UI", "Inter", sans-serif; background: #fff; }
		.sidebar { background-color: #f0f0f0; border-right: 1px solid #ccc; width: var(--sidebar-width); z-index: 10; }

		/* 隐藏 Docsify 默认列表 */
		.sidebar-nav { padding: 0 !important; margin: 0 !important; }
		.sidebar-nav > ul { display: none !important; }

		/* 自定义容器 */
		#custom-sidebar {
			padding: 10px 0;
			overflow-y: auto;
			height: 100%;
			box-sizing: border-box;
			font-size: 14px;
		}

		/* 节点样式 */
		.tree-node {
			display: flex;
			align-items: center;
			cursor: pointer;
			user-select: none;
			padding-right: 10px;
			transition: background 0.1s;
			height: var(--item-height);
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
			color: #333;
		}
		.tree-node:hover { background-color: #e8e8e8; }

		/* 文件夹 */
		.folder-row { font-weight: 600; color: #222; }

		.toggle-icon {
			display: inline-flex;
			justify-content: center;
			align-items: center;
			width: 14px;
			height: 14px;
			margin-right: 8px;
			background: #e0e0e0;
			border: 1px solid #999;
			border-radius: 2px;
			font-family: monospace;
			font-size: 12px;
			line-height: 10px;
			color: #333;
			font-weight: bold;
		}
		.folder-open > .folder-row .toggle-icon { background: #ccc; color: #000; }

		/* 子容器 */
		.children-container {
			display: none;
			padding-left: 22px;
			border-left: 1px solid rgba(0,0,0,0.05);
		}
		.folder-open > .children-container { display: block; }

		/* 文件 */
		.file-row { font-weight: 400; color: #555; }

		.file-dot {
			width: 6px;
			height: 6px;
			border-radius: 50%;
			background-color: #999;
			margin-right: 10px;
			margin-left: 4px;
		}

		/* 选中高亮 */
		.file-row.active {
			background-color: #dbebe9;
			color: #000;
			font-weight: 600;
			border-left: 4px solid var(--theme-color);
			padding-left: calc(var(--indent, 0px) - 4px);
		}
		.file-row.active .file-dot {
			background-color: var(--theme-color);
			box-shadow: 0 0 4px var(--theme-color);
		}

		.content { max-width: 1000px; margin: 0 auto; padding-top: 20px; }
	</style>
</head>
<body>
<div id="app">正在初始化引擎文档...</div>

<script>
	// ============================================================
	// [Logic] Markdown 解析器 (增强版：清洗语法)
	// ============================================================
	const SidebarParser = {
		parse: function(mdContent) {
			const lines = mdContent.split('\n');
			const root = { children: [] };
			const stack = [{ level: -1, node: root }];

			// 匹配列表行
			const regex = /^(\s*)([*+-])\s+(.*)$/;

			lines.forEach(line => {
				if (!line.trim()) return;

				const match = regex.exec(line);
				if (!match) return;

				const indentRaw = match[1];
				const contentRaw = match[3];
				const level = indentRaw.replace(/\t/g, '  ').length;

				// 解析链接与标题
				const linkMatch = /\[(.*?)\]\((.*?)\)/.exec(contentRaw);

				let rawTitle = linkMatch ? linkMatch[1] : contentRaw;
				const link = linkMatch ? linkMatch[2] : null;

				// --- [Fix 1] 清洗 Markdown 语法 ---
				// 1. 去除加粗/斜体 (**Text** -> Text)
				rawTitle = rawTitle.replace(/[*_]{1,2}(.*?)[*_]{1,2}/g, '$1');
				// 2. 去除 HTML 注释 (<!-- ... -->)
				rawTitle = rawTitle.replace(/<!--[\s\S]*?-->/g, '');
				// 3. 去除首尾空格
				const cleanTitle = rawTitle.trim();

				if (!cleanTitle) return; // 如果清洗完没字了(纯注释)，跳过

				const node = {
					title: cleanTitle,
					link: link,
					children: null
				};

				// 栈操作：找爸爸
				while (stack.length > 1 && level <= stack[stack.length - 1].level) {
					stack.pop();
				}

				const parent = stack[stack.length - 1].node;
				if (!parent.children) parent.children = [];
				parent.children.push(node);

				stack.push({ level: level, node: node });
			});

			return root.children;
		}
	};

	// ============================================================
	// [View] DOM 构建与状态管理 (增强版：防消失)
	// ============================================================
	const SidebarBuilder = {
		isBuilt: false,
		cachedDOM: null, // [Fix 2] 缓存构建好的 DOM 树

		init: function(fileUrl) {
			if (this.isBuilt) return Promise.resolve();

			return fetch(fileUrl)
				.then(res => {
					if (!res.ok) throw new Error("Sidebar 404");
					return res.text();
				})
				.then(md => {
					const treeData = SidebarParser.parse(md);
					// 构建 DOM 并缓存起来，不直接 append
					this.cachedDOM = this.buildDOM(treeData);
					this.isBuilt = true;
					// 首次挂载
					this.ensureMounted();
				})
				.catch(err => {
					console.error("Sidebar error:", err);
				});
		},

		// 构建 DOM 结构 (返回 Element)
		buildDOM: function(nodes) {
			const container = document.createElement('div');
			container.id = 'custom-sidebar';
			this.renderNodes(nodes, container);
			return container;
		},

		// [Fix 2] 确保 DOM 存在于页面上 (路由切换后重新挂载)
		ensureMounted: function() {
			if (!this.cachedDOM) return;

			const nav = document.querySelector('.sidebar-nav');
			if (!nav) return;

			// 检查是否被 Docsify 擦除了
			if (!document.getElementById('custom-sidebar')) {
				nav.innerHTML = ''; //以此为准
				nav.appendChild(this.cachedDOM);
			}
		},

		renderNodes: function(nodes, parentEl) {
			if (!nodes) return;
			nodes.forEach(node => {
				const hasChildren = node.children && node.children.length > 0;

				if (hasChildren) {
					// --- 文件夹 ---
					const wrapper = document.createElement('div');
					wrapper.className = 'folder-wrapper';

					const row = document.createElement('div');
					row.className = 'tree-node folder-row';
					row.onclick = (e) => {
						e.stopPropagation();
						this.toggleFolder(wrapper);
					};

					const icon = document.createElement('span');
					icon.className = 'toggle-icon';
					icon.innerText = '+';

					const text = document.createTextNode(node.title);

					row.appendChild(icon);
					row.appendChild(text);
					wrapper.appendChild(row);

					const childContainer = document.createElement('div');
					childContainer.className = 'children-container';
					this.renderNodes(node.children, childContainer);

					wrapper.appendChild(childContainer);
					parentEl.appendChild(wrapper);
				} else {
					// --- 文件 ---
					const row = document.createElement('div');
					row.className = 'tree-node file-row';

					const dot = document.createElement('span');
					dot.className = 'file-dot';
					const text = document.createTextNode(node.title);

					row.appendChild(dot);
					row.appendChild(text);

					if (node.link) {
						row.dataset.link = node.link;
						row.onclick = (e) => {
							e.stopPropagation();
							const targetPath = node.link.startsWith('/') ? node.link : '/' + node.link;

							const currentQuery = window.location.hash.split('?')[1];
							let finalHash = '#' + targetPath;
							if(currentQuery) finalHash += '?' + currentQuery;
							window.location.hash = finalHash;
						};
					}
					parentEl.appendChild(row);
				}
			});
		},

		toggleFolder: function(wrapper) {
			const isOpen = wrapper.classList.contains('folder-open');
			const icon = wrapper.querySelector('.toggle-icon');
			if (isOpen) {
				wrapper.classList.remove('folder-open');
				icon.innerText = '+';
			} else {
				wrapper.classList.add('folder-open');
				icon.innerText = '-';
			}
		},

		// 更新高亮和展开状态
		updateState: function() {
			if (!this.isBuilt) return;
			// 每次更新状态前，先确保 DOM 还在
			this.ensureMounted();

			let currentPath = location.hash.split('?')[0].replace('#', '');
			if (currentPath === '') currentPath = '/';

			const allFiles = document.querySelectorAll('.file-row');
			allFiles.forEach(row => row.classList.remove('active'));

			let activeRow = null;
			for (let row of allFiles) {
				const link = row.dataset.link;
				if (!link) continue;
				const cleanLink = link.replace('.md', '');
				const cleanCurr = currentPath.replace('.md', '');

				if (cleanLink === cleanCurr || cleanLink + '/README' === cleanCurr) {
					activeRow = row;
					break;
				}
			}

			if (activeRow) {
				activeRow.classList.add('active');
				this.expandParents(activeRow);
			}
		},

		expandParents: function(domElement) {
			let parent = domElement.parentElement;
			while (parent && parent.id !== 'custom-sidebar') {
				if (parent.classList.contains('folder-wrapper')) {
					if (!parent.classList.contains('folder-open')) {
						parent.classList.add('folder-open');
						const icon = parent.querySelector('.toggle-icon');
						if(icon) icon.innerText = '-';
					}
				}
				parent = parent.parentElement;
			}
		}
	};

	// ============================================================
	// Docsify Config
	// ============================================================
	window.$docsify = {
		name: 'GDEngine',
		repo: '',
		loadSidebar: false,
		subMaxLevel: 2,
		relativePath: true,
		executeScript: true,
		auto2top: true,
		themeColor: '#09D2B8',

		plugins: [
			function(hook, vm) {
				// 首次加载
				hook.mounted(function() {
					SidebarBuilder.init('_sidebar.md').then(() => {
						SidebarBuilder.updateState();
					});
				});

				// [Fix 2] 每次路由切换完，检查DOM是否还在，不在就挂上去，然后同步状态
				hook.doneEach(function() {
					SidebarBuilder.updateState();
				});
			}
		]
	}
</script>
<script src="https://cdn.jsdelivr.net/npm/docsify@4/lib/docsify.min.js"></script>
</body>
</html>
